<!DOCTYPE html>
<html lang="ru">
<head>
	<title>Работа с данными в браузере и производительность web-приложений, HTTP/2</title>
	<meta charset="utf-8">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<script>
		'use strict';

		const gcd = (a, b) => (b === 0) ? a : gcd(b, a % b);
		const w = screen.width;
		const h = screen.height;
		const r = gcd(w, h);

		console.log(`${w}x${h}`);
		let aspect = `${w / r}x${h / r}`;
		console.log(aspect);

		const ratios = ['8x5', '4x3', '6x5', '5x3', '5x4', '16x9'];
		if (!ratios.includes(aspect)) {
			aspect = ratios[0];
		}

		if (['localhost', '127.0.0.1'].includes(window.location.hostname)) {
			aspect = '4x3';
		}
		aspect = '4x3';

		document.write(`<link rel="stylesheet" href="/lib/shower/themes/technopark/styles/screen-${aspect}.css">`);

	</script>

	<link rel="stylesheet" href="/lib/slides.css">

</head>
<body class="shower list">

<header class="caption">
	<h1>Работа с данными в браузере и производительность web-приложений, HTTP/2</h1>
	<p>Технопарк, осень, 2017 г.</p>
</header>

<section class="slide first">
	<h2 class="shout"><span style="display: inline-block; font-size: 88px; line-height: 80px;">Производительность web-приложений</span><br/>
		<small>Слайды доступны по ссылке<br/>
			<a href="https://frontend-park-mailru.firebaseapp.com/">frontend-park-mailru.firebaseapp.com</a>
		</small>
	</h2>
</section>

<section class="slide question">
	<h2>
		<span style="display: inline-block; font-size: 75%">Из чего складывается производительность WEB'а?</span>
	</h2>
</section>

<section class="slide">
	<h2>Производительность WEB'а</h2>
	<p class="small-content"></p>
	<ul>
		<li>Производительность во время работы web-приложения &mdash; <em>о ней чуть позже: через пару лекций</em></li>
		<li>Производительность во время загрузки web-приложения &mdash; <em>а вот про это как раз наша лекция</em></li>
	</ul>
</section>

<section class="slide">
	<h2>Что происходит во время <br> HTTP-запроса?</h2>
	<div style="position: relative; width: 100%; height: 80%;">
		<img class="place" src="http-request-stages.png"
			 style="transform-origin: center; transform: translate(-50%,-50%) scale(0.9);">
	</div>
</section>

<section class="slide">
	<h2>Что происходит во время <br> HTTP-запроса?</h2>
	<div style="position: relative; width: 100%; height: 80%;">
		<img class="place" src="timing.png"
			 style="transform-origin: center; transform: translate(-50%,-50%) scale(1.1);">
	</div>
</section>

<section class="slide">
	<h2>HTTP-latency</h2>
	<div style="position:relative;width: 100%;height: 75%;margin: 0 auto;"><img class="place" src="images/latency.png"
																				style="transform-origin: center;transform: translate(-50%,-50%) scale(0.95);">
	</div>
</section>

<section class="slide">
	<h2>HTTP-latency</h2>
	<div style="position:relative;width: 100%;height: 75%;margin: 0 auto;"><img class="place"
																				src="images/latency-bandwidth.svg"
																				style="transform-origin: center;transform: translate(-50%,-50%) scale(0.8);">
	</div>
</section>

<section class="slide">
	<h2>Как оптимизировать?</h2>
	<div style="position:relative;width: 100%;height: 75%;margin: 0 auto;"><img class="place"
																				src="html5_link_prefetch.png"
																				style="transform-origin: center;transform: translate(-50%,-50%) scale(0.9);">
	</div>
</section>

<section class="slide">
	<h2>prefetch, preconnect, preload</h2>
	<pre class="hljs html">
		<code>&lt;!--  резолвит DNS заранее --&gt;</code>
		<code>&lt;meta http-equiv="x-dns-prefetch-control" content="on"&gt;</code>
		<code>&lt;link rel="dns-prefetch" href="//api.myawesomegame.io"&gt;</code>
		<code>&lt;!-- dns-prefetch на стероидах, также инициирует коннект --&gt;</code>
		<code>&lt;link rel="preconnect" href="//api.myawesomegame.io"&gt;</code>
		<code> </code>
		<code>&lt;!-- загружает ресурс с низким приоритетом и кладет в кеш --&gt;</code>
		<code>&lt;link rel="prefetch" href="https://myawesomegame.io/img/sprite.jpg"&gt;</code>
		<code>&lt;!-- загружает ресурс с высоким приоритетом и кладет в кеш --&gt;</code>
		<code>&lt;link rel="subresource" href="https://myawesomegame.io/img/sprite.jpg"&gt;</code>
		<code> </code>
		<code>&lt;!-- загружает страницу со всем содержимым в фоне, строит DOM --&gt;</code>
		<code>&lt;link rel="prerender" href="https://myawesomegame.io/about.html"&gt;</code>
	</pre>
</section>

<section class="slide">
	<h2>Предзагрузка картинок через JS</h2>
	<pre class="hljs js">
			<code>const img = new Image();</code>
			<code>img.src = 'https://myawesomegame.io/img/sprite.jpg';</code>
		</pre>
</section>

<section class="slide">
	<h2>DOMContentLoaded и load</h2>
	<div>
		<div>DOMContentLoaded возникает на построение DOM-дерева</div>
		<pre class="hljs js">
			<code>document.addEventListener("DOMContentLoaded", () => {</code>
			<code>  // DOM дерево построено, но загружены не все ресурсы</code>
			<code>});</code>
		</pre>
		<div>
			<small>DOMContentLoaded зависит от скриптов на странице</small>
		</div>
		<br/>
		<div>load возникнет, когда все ресурсы (стили, шрифты, картинки) будут загружены</div>
		<pre class="hljs js">
			<code>document.addEventListener("load", () => {</code>
			<code>  // Все ресурсы загружены</code>
			<code>});</code>
		</pre>
	</div>
</section>

<section class="slide">
	<h2>PerformanceTiming</h2>
	<pre class="hljs js">
		<code>window.performance.timing</code>
		содержит все события, происходившие с загрузкой страницы
		<code>window.performance.timing.fetchStart</code>
		<code>window.performance.timing.domainLookupStart</code>
		<code>window.performance.timing.domainLookupEnd</code>
	</pre>
</section>

<section class="slide">
	<h2>Performance Entries</h2>
	<div style="position:relative;width: 100%;height: 75%;margin: 0 auto;"><img class="place"
																				src="entries.png"
																				style="transform-origin: center;transform: translate(-50%,-47%) scale(0.4);">
	</div>
</section>

<section class="slide">
	<h2>Уменьшаем время загрузки данных</h2>
	<h3><b>Минификация статики (стили, скрипты, картинки)</b></h3>
	<div>jquery.js<span style="padding-left: 53px;"></span>&rarr; 278KB</div>
	<div>jquery.min.js &rarr; 101KB</div>
</section>

<section class="slide">
	<h2>Уменьшаем время загрузки данных</h2>
	<h3><b>Сжатие ответа</b></h3>
	<pre class="hljs http">
		<code>Content-Encoding: gzip</code>
	</pre>

	<ul style="font-size: 90%">
		<li>Минификация и оптимизация статики, картинок, скриптов, стилей, шрифтов, html. Сжатие тела ответа (gzip),
			сравнение минификации/оптимизации/сжатия через gzip. Zopfli/Brotli - поддержка браузерами и сравнение
			производительности сжатия/разжатия. Сравнение на разных типах содержимого (Brotli для текста, Zopfli для
			бинарных данных). Фишка того, что в Brotli долго сжимается, зато хорошо и быстро распаковывается.
		</li>
		<li>"Сжатие" данных за счёт новых форматов данных, WebP для картинок, WebM для мультимедиа, WOFF /WOFF2 для
			шрифтов, protobuf
		</li>
		<li>Кэширование в HTTP, кэширование заголовков (например CORS), кэширование DNS, хаки кэширования (уникальные
			имена для бандлов, чтобы закешировать его навсегда и рандомные гет-параметры, чтобы "отключить" кэширование)
		</li>
		<li>Как не выстрелить себе в голову с кэшированием</li>
	</ul>
</section>

<section class="slide">
	<h2>Уменьшаем время загрузки данных</h2>
	<h3><b>Форматы</b></h3>
	WebP WebM Woff2
</section>

<section class="slide">
	<h2>Уменьшаем время загрузки данных</h2>
	<h3><b>Форматы</b></h3>
	Protobuf
</section>

<section class="slide">
	<h2>HTTP weakness. One request per connection</h2>
	<div style="position:relative;width: 100%;height: 75%;margin: 0 auto;"><img class="place"
																				src="images/one-request-per-connection.png"
																				style="transform-origin: center;transform: translate(-50%,-50%) scale(1.2);">
	</div>
</section>

<section class="slide">
	<h2>Уменьшаем количество запросов</h2>
	<img class="place" src="images/http:1-loading.png"
		 style="transform-origin: left top;top: 0;left: 0;transform: translate(0px, 0px) scale(1.25);">
	Конкатенация скриптов, стилей
</section>

<section class="slide">
	<h2>Connection: keep-alive</h2>
</section>

<section class="slide">
	<h2>Как побороть недостатки HTTP?</h2>
	<ul>
		<li>Долгая установка соединения и хак с конкатенацией статики (стили, спрайты, скрипты) чтобы уменьшить
			количество запросов
		</li>
		<li>Один запрос на соединение и connection: keep-alive/close</li>
		<li>предкэширование https-конекшенов *</li>
		<li>Max. 6 connections per domain и domain-шардинг</li>
		<li>То, что с запросом отправляется 100500 мегабайт кук и всего такого и вынесение статики на отдельные домены,
			чтобы туда куки не отправлялись
		</li>
		<li>Инлайн данных, base64 картинок/шрифтов, критикал css, критикал js и критикал html</li>
	</ul>
</section>

<section class="slide">
	<h2>Кэширование</h2>
	<div style="position:relative;width: 100%; height: 75%;"><img class="place" src="cache.jpg"
																  style="transform-origin: center;transform: translate(-50%,-45%) scale(1);">
	</div>
</section>

<section class="slide">
	<h2>Кэширование</h2>
	<blockquote>
		<p class="small-content"><b>Кэширование</b> &mdash; повторное использование ресурсов для работы приложения.
			Использование кэшей позволяет уменьшить задержку и расходование сетевого трафика и тем самым уменьшить
			время, необходимое для отображения ресурса. <b>HTTP-кэширование</b> &mdash; кэширование ответов на
			HTTP-запросы</p>
	</blockquote>
</section>

<section class="slide">
	<h2>Кэширование</h2>
	<pre class="hljs http">
			<code>// Запрос обыкновенный</code>
			<code>GET /script.js HTTP/1.1</code>
			<code>Host: example.com</code>
			<code>Accept: */*</code>
			<code> </code>
		</pre>
</section>

<section class="slide">
	<h2>Кэширование</h2>
	<pre class="hljs http">
			<code>// Ответ на запрос</code>
			<code>HTTP/1.1 200 OK</code>
			<code>Content-Type: application/javascript; charset=UTF-8</code>
			<code>Cache-Control: public, max-age=86400</code>
			<code>Last-Modified: Sat, 25 Mar 2017 12:00:00 GMT</code>
			<code>ETag: W/"7349b-15b075b6d60"</code>
			<code> </code>
		</pre>
</section>

<section class="slide">
	<h2><code>Cache-Control</code></h2>
	<p>Возможные значения</p>
	<ul lang="ru">
		<li><code>no-cache</code></li>
		<li><code>no-store</code></li>
		<li><code>must-revalidate</code></li>
		<li><code>private/public</code></li>
		<li><code>max-age=31536000</code></li>
	</ul>
</section>

<section class="slide">
	<h2>Проверка "свежести"</h2>
	<pre class="hljs http">
			<code>// Ответ на запрос</code>
			<code>HTTP/1.1 200 OK</code>
			<code>...</code>
			<code>Last-Modified: Sat, 25 Mar 2017 12:00:00 GMT</code>
			<code>...</code>
			<code> </code>
		</pre>
</section>

<section class="slide">
	<h2>Проверка "свежести"</h2>
	<pre class="hljs http">
			<code>GET /script.js HTTP/1.1</code>
			<code>Host: example.com</code>
			<code>If-Modified-Since: Sat, 25 Mar 2017 12:00:00 GMT</code>
			<code> </code>
		</pre>
	<pre class="hljs http">
			<code>HTTP/1.1 304 Not Modified   // Контент не изменился</code>
			<code>HTTP/1.1 200 OK             // Новый контент</code>
			<code> </code>
		</pre>
</section>

<section class="slide">
	<h2>Проверка
		<mark><em>валидности</em></mark>
	</h2>
	<pre class="hljs http">
			<code>// Ответ на запрос</code>
			<code>HTTP/1.1 200 OK</code>
			<code>...</code>
			<code>ETag: W/"7349b-15b075b6d60"</code>
			<code>...</code>
			<code> </code>
		</pre>
</section>

<section class="slide">
	<h2>Проверка
		<mark><em>валидности</em></mark>
	</h2>
	<pre class="hljs http">
			<code>GET /script.js HTTP/1.1</code>
			<code>Host: example.com</code>
			<code>If-None-Match: W/"7349b-15b075b6d60"</code>
			<code> </code>
		</pre>
	<pre class="hljs http">
			<code>HTTP/1.1 304 Not Modified   // Контент не изменился</code>
			<code>HTTP/1.1 200 OK             // Новый контент</code>
			<code> </code>
		</pre>
</section>

<section class="slide">
	<h2>"Управление" кэшированием</h2>
	<ul>
		<li><span>Гет-параметр:</span><br><code>GET /script.js?_=1492172324776</code></li>
		<li><span>Уникальные имена:</span><br><code>GET /bundle.026f8e459c8f89ef75fa7a78265a0025.js</code></li>
	</ul>
</section>

<section class="slide question">
	<h2>Хранение данных</h2>
</section>

<section class="slide">
	<h2>Хранение данных</h2>
	<p class="small-content"></p>
	<ul lang="ru">
		<li><code>localStorage</code></li>
		<li><code>sessionStorage</code></li>
		<li>WebSQL</li>
		<li>IndexedDB</li>
		<li>FileSystem</li>
	</ul>
</section>

<section class="slide">
	<h2><code>window.localStorage</code></h2>
	<p class="small-content"></p>
	<pre class="hljs js">
			<code>localStorage[key];         /* String */</code>
			<code>localStorage[key] = value; /* String */</code>
			<code> </code>
		</pre>
</section>

<section class="slide">
	<h2><code>window.localStorage</code></h2>
	<pre class="hljs js">
			<code>localStorage.length</code>
			<code>localStorage.key(i)          /* String */</code>
			<code>localStorage.getItem(key)    /* String */</code>
			<code>localStorage.setItem(key, value)</code>
			<code>localStorage.removeItem(key)</code>
			<code>localStorage.clear()</code>
			<code> </code>
		</pre>
</section>

<section class="slide">
	<h2>Событие <code>storage</code></h2>
	<pre class="hljs js">
			<code>window.addEventListener('storage', function (e) {</code>
			<code>    /* e.key, e.newValue */</code>
			<code>    ...</code>
			<code>});</code>
			<code> </code>
		</pre>
</section>

<section class="slide">
	<h2>JSON</h2>
	<pre class="hljs js">
			<code>function setJSON(key, value) {</code>
			<code>    localStorage[key] = JSON.stringify(value);</code>
			<code>}</code>
			<code>function getJSON(key) {</code>
			<code>    const value = localStorage[key];</code>
			<code>    return value ? JSON.parse(value) : null;</code>
			<code>}</code>
			<code> </code>
		</pre>
</section>

<section class="slide">
	<h2>Хранение данных</h2>
	<p class="small-content"></p>
	<ul lang="ru">
		<li>WebSQL &mdash; 5 MB</li>
		<li>IndexedDB &mdash; 50 MB</li>
		<li>FileSystem &mdash; <a href="https://www.w3.org/TR/FileAPI/" target="_blank">File API</a>
			<ul>
				<li><a href="https://habrahabr.ru/post/112286/" target="_blank">Статья на Хабре</a></li>
				<li><a href="https://developer.mozilla.org/ru/docs/Web/API/FileSystem" target="_blank">FileSystem API |
					MDN</a></li>
				<li><a href="http://www.htmlfivewow.com/demos/terminal/terminal.html" target="_blank">Терминал в
					браузере, работающий с файловой системой</a></li>
			</ul>
		</li>
	</ul>
</section>

<section class="slide">
	<h2 class="shout">Service Workers</h2>
</section>

<section class="slide">
	<h2>Ещё более умное кэширование (service-workers) [про обычные воркеры я уже упоминал на лекции, они чуть-чуть в
		курсе]</h2>
	<ul>
		<li>Поддержка, плюсы и минусы, зачем используется</li>
		<li>Жизненный цикл, создание и установка воркера</li>
		<li>Пример кода для оффлайн-работы с sw</li>
		<li>Обязательно картинку https://mdn.mozillademos.org/files/12630/important-notes.png (из статьи
			https://developer.mozilla.org/ru/docs/Web/API/Service_Worker_API/Using_Service_Workers)
		</li>
		<li>Как ещё можно использовать сервис-воркеры (пример из телеграма, где они в веб-версии перекодировали картинки
			из крутых форматов, чтобы показывать стикеры быстро)
		</li>
	</ul>
</section>

<section class="slide">
	<h2>Service Workers</h2>
	<blockquote>
		<p class="medium-content"><strong>Service Workers</strong> &mdash; продвинутая технология, которая позволяет получить полный контроль над жизненным циклом приложения. Сервис воркер &mdash; это воркер, который:
		<ul>
			<li>работает в выделенном контексте и отдельном потоке</li>
			<li>имеет доступ к Cache Storage (расширенное хранилище данных)</li>
			<li>имеет возможность перехватывать HTTP-запросы, отправляемые страницей</li>
			<li>а так же <strong>может работать даже если само web-приложение или даже браузер не запущены</strong></li>
		</ul>
	</blockquote>
	<p class="note">Подробнее &mdash; по <a href="https://developer.mozilla.org/ru/docs/Web/API/Service_Worker_API/Using_Service_Workers" target="_blank">ссылке на MDN</a></p>
</section>

<section class="slide">
	<h2>Service Workers используются</h2>
	<p class="medium-content"></p>
	<ul>
		<li>Кэширование данных (50MB+)</li>
		<li><strong>Оффлайн-работа приложения</strong> (прям вообще без Интернета чтобы было!)</li>
		<li>Фоновая синхронизация данных</li>
		<li>Ответ на запросы от других источников ("проксирование" запросов)</li>
		<li>Улучшение производительности</li>
		<li>Push-нотификации</li>
		<li>Распараллеливание вычислений</li>
		<li>etc...</li>
	</ul>
</section>

<section class="slide">
	<h2>Service Workers &mdash; <a href="https://caniuse.com/#feat=serviceworkers" target="_blank">caniuse</a></h2>
	<div style="position: relative; width: 100%; height: 75%; margin: 0 auto;">
		<img class="place" src="sw-caniuse.png" style="transform-origin: center; transform: translate(-50.4%,-50%) scale(0.8);">
	</div>
</section>

<section class="slide">
	<h2>Service Workers</h2>
	<p class="medium-content">Работает в специальном скоупе <code>ServiceWorkerGlobalScope</code>, который не имеет доступа к обычному скоупу с <code>window</code><br>Имеет несколько событий, на которые можно навешивать обработчики:</p>
	<pre class="hljs js">
		<code>this.addEventListener('install', listener);  // SW зарегистрировали</code>
		<code>this.addEventListener('activate', listener); // SW запустили</code>
		<code>this.addEventListener('fetch', listener);    // SW перехватил запрос</code>
		<code>this.addEventListener('message', listener);  // SW получил push</code>
		<code> </code>
	</pre>
</section>

<section class="slide">
	<h2>Service Worker lifecycle</h2>
	<div style="position: relative; width: 100%; height: 75%; margin: 0 auto;">
		<img class="place" src="sw-lifecycle.png" style="transform-origin: center; transform: translate(-56%,-50%) scale(0.85);">
	</div>
</section>

<section class="slide">
	<h2>Установка Service Worker'а</h2>
	<pre class="hljs js">
		<code>navigator.serviceWorker.register('/sw.js', { scope: '/' })</code>
		<code>    .then(function(registration) {</code>
		<code>        // Registration was successful</code>
		<code>        console.log('SW registration OK:', registration);</code>
		<code>    })</code>
		<code>    .catch(function(err) {</code>
		<code>        // registration failed :(</code>
		<code>        console.log('SW registration FAIL:', err);</code>
		<code>    });</code>
		<code>});</code>
		<code> </code>
	</pre>
</section>

<section class="slide">
	<h2>Service Worker notes</h2>
	<div style="position: relative; width: 100%; height: 75%; margin: 0 auto;">
		<img class="place" src="sw-notes.png" style="transform-origin: center; transform: translate(-50%,-50%) scale(1.7);">
	</div>
</section>

<section class="slide">
	<h2>Service Worker &mdash; это просто файл</h2>
	<pre class="hljs js">
			<code>this.addEventListener('install', function (event) {</code>
			<code>    console.log('Service worker установлен')</code>
			<code>    event.waitUntil(</code>
			<code>        // находим Cache-объект с нашим именем</code>
			<code>        caches.open('MY_CACHE')</code>
			<code>            .then(function (cache) {</code>
			<code>                // загружаем в наш cache необходимые файлы</code>
			<code>                return cache.addAll(['/index.html']);</code>
			<code>            });</code>
			<code>    );</code>
			<code>});</code>
			<code> </code>
		</pre>
</section>

<section class="slide question">
	<h2>Практика с Service Workers</h2>
</section>

<section class="slide question">
	<h2>Ещё примеры использования Service Workers</h2>
</section>

<section class="slide">
	<h2 class="shout">Протокол WebSocket</h2>
</section>

<section class="slide">
	<h2>WebSocket</h2>
	<blockquote>
		<p class="medium-content"><strong>Протокол WebSocket</strong> &mdash; протокол полнодуплексной связи (может передавать и принимать одновременно) <mark>поверх TCP-соединения</mark>, предназначенный для обмена сообщениями <mark>между браузером и веб-сервером в режиме реального времени</mark>. С помощью его API вы можете отправить сообщение на сервер и получить ответ без выполнения отдельного HTTP-запроса, причем этот процесс будет событийно-управляемым</p>
	</blockquote>
	<p class="note">Были созданы, чтобы обойти ограничение HTTP на формат запрос/ответ и дать возможность отправлять сообщения <mark>с сервера на клиент</mark></p>
	<p>Подробнее &mdash; по <a href="https://learn.javascript.ru/websockets" target="_blank">ссылке на learn.javascript.ru</a></p>
</section>

<section class="slide">
	<h2>Поддержка браузерами &mdash; <a href="https://caniuse.com/#feat=websockets" target="_blank">caniuse</a></h2>
	<div style="position: relative; width: 100%; height: 80%;">
		<img class="place" src="ws-caniuse.png"
			 style="transform-origin: center; transform: translate(-50%,-65%) scale(0.75);">
	</div>
</section>

<section class="slide">
	<h2>Преимущества WebSocket</h2>
	<p class="medium-content"></p>
	<ul>
		<li>Поддерживает возможность отправки сообщений с сервера на клиент</li>
		<li>Все сообщения проходят через одно TCP-соединение, поэтому отсутствует overhead на открытие соединения</li>
		<li>Очень хорошая поддержка браузерами и очень простой API использования</li>
	</ul>
	<p><em>Именно поэтому WebSocket'ы очень удобно использовать для написания:</em></p>
	<ul>
		<li>Реалтаймовых игр (для обмена сообщениями между клиентом и сервером)</li>
		<li>Чатов и веб-мессенджеров</li>
		<li>PUSH-уведомления и прочие нотификации от сервера</li>
	</ul>
</section>

<section class="slide">
	<h2>Создание <code>WebSocket</code></h2>
	<p class="medium-content"></p>
	<pre class="hljs js">
		<code>const ws = new WebSocket('ws://example.com/ws');</code>
		<code> </code>
		<code>// если страница загружена по https://</code>
		<code>const ws = new WebSocket('<mark>wss</mark>://example.com/ws');</code>
		<code> </code>
		<code>// События WebSocket</code>
		<code>ws.addEventListener('open', listener);     // соединение установлено</code>
		<code>ws.addEventListener('message', listener);  // пришло новое сообщение</code>
		<code>ws.addEventListener('error', listener);    // ошибка</code>
		<code>ws.addEventListener('close', listener);    // сокет закрылся</code>
		<code> </code>
	</pre>
</section>

<section class="slide">
	<h2>Работа с WebSocket</h2>
	<p>После создания объекта WebSocket <strong>необходимо дождаться</strong>, пока соединение не откроется и не установится:</p>
	<pre class="hljs js">
		<code>ws.onopen = function() {</code>
		<code>    console.log('Соединение установлено, можно отправлять сообщения!');</code>
		<code> </code>
		<code>    // Отправка текста</code>
		<code>    ws.send('Hello!');</code>
		<code>    ws.send(JSON.stringify({ x: 100, y: 150 }));</code>
		<code> </code>
		<code>    // Отправка бинарных данных (например файлы из формы)</code>
		<code>    ws.send(form.elements[0].file);</code>
		<code>};</code>
		<code> </code>
	</pre>
</section>

<section class="slide">
	<h2>Событие <code>error</code> и <code>close</code></h2>
	<pre class="hljs js">
		<code>ws.onerror = function(error) {</code>
		<code>    // произошла ошибка в отправке/приёме данных или сетевая ошибка</code>
		<code>    console.log('Ошибка ' + error.message);</code>
		<code>};</code>
		<code> </code>
		<code>ws.onclose = function(event) {</code>
		<code>    // 1000 - штатное закрытие сокета <mark>(коды WebSocket из 4х цифр)</mark></code>
		<code>    // 1001 - удалённая сторона исчезла</code>
		<code>    // 1002 - ошибка протокола</code>
		<code>    // 1003 - неверный запрос</code>
		<code>    console.log('Код: ' + event.code);</code>
		<code>    console.log('Причина: ' + event.reason);</code>
		<code>};</code>
		<code> </code>
	</pre>
</section>

<section class="slide">
	<h2>Событие <code>message</code> &mdash; обработка <br>сообщений с сервера</h2>
	<pre class="hljs js">
		<code>ws.onmessage = function(event) {</code>
		<code>    const data = event.data;</code>
		<code>    const message = JSON.parse(data);</code>
		<code> </code>
		<code>    console.log('Прислали сообщение: ' + message.text);</code>
		<code> </code>
		<code>    // или, если есть глобальная шина событий</code>
		<code>    <mark>bus.emit</mark>(message.event, message.payload);</code>
		<code>};</code>
		<code> </code>
	</pre>
</section>

<section class="slide">
	<h2>Как использовать WebSocket</h2>
	<ol>
		<li>Договориться о своём "надпротоколе" обмена сообщениями между клиентом и сервером &mdash; зафиксировать форматы всех сообщений в приложении. Например:</li>
	</ol>
	<pre class="hljs json">
		<code>{</code>
		<code>    "action": "FIRE",</code>
		<code>    "payload": { "cell": "b4" }</code>
		<code>}</code>
		<code> </code>
		<code>{</code>
		<code>    "action": "FIRE_RESULT",</code>
		<code>    "payload": { "state": "Убил" }</code>
		<code>}</code>
		<code> </code>
	</pre>
</section>

<section class="slide">
	<h2>Как использовать WebSocket</h2>
	<ol>
		<li value="2">Написать обёртку вокруг WebSocket, которая будет внутри себя заниматься отправкой и приёмом сообщений, а наружу будет предоставлять удобный интерфейс:</li>
	</ol>
	<pre class="hljs js">
		<code>const webSocketService = new WebSocketService('/ws');</code>
		<code> </code>
		<code>webSocketService.send('FIRE', { "cell": "b4" });</code>
		<code>webSocketService.subscribe('FIRE_RESULT', function (payload) {</code>
		<code>    const state = payload.state;</code>
		<code>    game.reRender(state);</code>
		<code>});</code>
		<code> </code>
	</pre>
</section>

<section class="slide">
	<h2 class="shout">HTTP/2</h2>
</section>

<section class="slide">
	<h2>Original HTTP/0.9 implementation</h2>
	<iframe
			src="https://www.w3.org/Protocols/HTTP/AsImplemented.html"
			frameborder="0" width="100%"
			height="80%"></iframe>
</section>

<section class="slide">
	<h2>Hypertext Transfer Protocol: HTTP/1.1</h2>
	<div style="position: relative; width: 100%; height: 100%; overflow: hidden; margin: 0 auto;">
		<iframe src="https://rfc2.ru/2068.rfc/original"
				frameborder="0" width="100%" height="80%"
				style="transform-origin: center; transform: translate(10%, -10%) scale(1.2)"></iframe>
	</div>
</section>

<section class="slide">
	<h2>Основные недостатки HTTP/1.1</h2>
	<p>HTTP/1.1 был спроектирован для сетей с более низкими пропускными способностями (bandwidth) и более высокими задержками (latency), чем сейчас. Поэтому у него есть недостатки:</p>
	<ul lang="ru">
		<li><mark>Ровно один параллельный</mark> запрос на соединение</li>
		<li>Ограничение в <mark>6 параллельных запросов на домен</mark></li>
		<li>Запросы инициируются <mark>исключительно клиентом</mark></li>
		<li><mark>Излишние и несжимаемые</mark> заголовки запроса и ответа</li>
		<li><mark>Опциональное</mark> сжатие данных</li>
		<li>HTTP очень <mark>медленный</mark>, но HTTPS <mark>ещё медленнее</mark></li>
	</ul>
</section>

<section class="slide">
	<h2>HTTP/2</h2>
	<p>HTTP/2 создавался с целью улучшить скорость работы web-приложений, за счёт уменьшения сетевых задержек и более удобного управления ресурсами в web. Основные особенности:</p>
	<ul lang="ru">
		<li><mark>Более быстрый старт соединения</mark> и улучшенное сжатие данных</li>
		<li><mark>Неограниченное количество</mark> запросов на соединение: на домен открывается единственное соединение, через которое <mark>отправляются все запросы</mark></li>
		<li>Возможность <mark>приоритезации и форсированной загрузки</mark> ресурсов</li>
		<li>Как следствие, <mark>64% уменьшение</mark> времени загрузки на <mark>неоптимизированных</mark> страницах (на мобильных устройствах доходит до 23%)</li>
		<li><mark>Обратно-совместим</mark> с HTTP/1.1, требует для работы <mark>HTTPS</mark></li>
	</ul>
</section>

<section class="slide">
	<h2>HTTP/2 требует наличие <br>поддержки на сервере и на клиенте</h2>
	<p class="medium-content">Сервера, которые поддерживают HTTP/2:</p>
	<ul lang="ru">
		<li>nginx 1.9.5</li>
		<li>node.js 5.0</li>
		<li>Apache 2.4.12</li>
		<li>Jetty 9.3 and Netty 4.1 (Java)</li>
		<li>❤️ Go 1.6</li>
		<li>and more...</li>
	</ul>
</section>

<section class="slide">
	<h2>HTTP/2 требует наличие <br>поддержки на сервере и на клиенте</h2>
	<p>Поддержка браузерами &mdash; <a href="https://caniuse.com/#feat=http2" target="_blank">caniuse</a></p>
	<div style="position:relative;width: 100%;height: 80%;">
		<img class="place" src="http2-caniuse.png"
			 style="transform-origin: center; transform: translate(-50%, -70%) scale(0.75);">
	</div>
</section>

<section class="slide">
	<h2>Главные фичи HTTP/2</h2>
	<p class="medium-content"></p>
	<ul lang="ru">
		<li>Мультиплексирование запросов (через стримы (потоки), фреймы (кадры) и сообщения)</li>
		<li>Бинарный формат сообщений</li>
		<li>Приоритезация загрузки ресурсов</li>
		<li>Управление загрузкой ресурсов</li>
		<li>Сжимание заголовков запросов и ответов</li>
		<li>Server push</li>
		<li>Что-то ещё?</li>
	</ul>
</section>

<section class="slide">
	<h2>Streams, Messages, and Frames</h2>
	<blockquote>
		<p><b>Stream</b> &mdash; двунаправленный поток байтов через установленное соединение, который может состоять из одного или более сообщений</p>
	</blockquote>
	<blockquote>
		<p><b>Message</b> &mdash; целостная последовательность фреймов, которая составляет полное логическое сообщение: запрос или ответ</p>
	</blockquote>
	<blockquote>
		<p><b>Frame</b> &mdash; минимальная единица коммуникации в HTTP/2. Каждый фрейм содержит заголовок фрейма, который идентифицирует, к какому сообщению внутри стрима относится это фрейм</p>
	</blockquote>
</section>

<section class="slide">
	<h2>Streams, Messages, and Frames</h2>
	<div style="position:relative;width: 100%;height: 80%;">
		<img class="place" src="images/streams-messages-frames.svg" style="transform-origin: center;transform: translate(-50%, -50%) scale(0.65);">
	</div>
</section>

<section class="slide">
	<h2>Streams, Messages, and Frames</h2>
	<ul>
		<li>ОДНО ЕДИНСТВЕННОЕ <mark>TCP соединение</mark></li>
		<ul>
			<li>ЛЮБОЕ количество <mark>двунаправленных стримов</mark></li>
			<ul>
				<li>КАЖДЫЙ стрим имеет уникальный идентификатор и некоторые флаги приоритета, которые позволяют <mark>управлять потоком двунаправленных сообщений</mark></li>
				<ul>
					<li>КАЖДОЕ сообщение представляет собой HTTP-сообщение, например запрос или ответ, каждое из которых состоит из <mark>одного или более фреймов</mark></li>
					<ul>
						<li>ФРЕЙМ &mdash; <mark>минимальная единица коммуникации</mark> содержит в себе часть данных запроса или ответа</li>
					</ul>
				</ul>
			</ul>
		</ul>
	</ul>
</section>

<section class="slide">
	<h2>Бинарный формат сообщений</h2>
	<div style="position:relative;width: 100%;height: 80%;">
		<img class="place" src="images/binary-layer.svg" style="transform-origin: center;transform: translate(-50%, -50%) scale(1);">
	</div>
</section>

<section class="slide">
	<h2>Бинарный формат сообщений</h2>
	<div style="position:relative;width: 100%;height: 80%;">
		<img class="place" src="images/binary-http2.svg" style="transform-origin: center;transform: translate(-50%, -50%) scale(1);">
	</div>
</section>

<section class="slide">
	<h2>Мультиплексирование запросов <br>и ответов</h2>
	<div style="position:relative;width: 100%;height: 80%;">
		<img class="place" src="images/http2-connection.svg" style="transform-origin: center;transform: translate(-50%, -50%) scale(1);">
	</div>
</section>

<section class="slide">
	<h2>Мультиплексирование запросов <br>и ответов</h2>
	<div style="position:relative;width: 100%;height: 80%;">
		<img class="place" src="images/many-wires.png" style="transform-origin: center;transform: translate(-50%, -65%) scale(0.27);">
		<div style="overflow:hidden;height:10%;position:relative;transform:translate(0%, 250px)">
			<img class="place" src="images/one-wire.jpg" style="transform-origin: center;transform: translate(-46%, -50%) rotate(45deg) scale(0.65);">
		</div>
	</div>
</section>

<section class="slide">
	<div style="position:fixed;width: 100%;height: 100%; top: 0; left: 0;">
		<img class="place" src="images/http:1-loading.png" style="transform-origin: left top;top: 0;left: 0;transform: translate(0px, 0px) scale(1.25);">
		<img class="place" src="images/http:2-loading.png" style="transform-origin: left top;top: 0;transform: translate(40%, 0px) scale(1.25);">
	</div>
</section>

<section class="slide">
	<h2>Приоретизация стримов</h2>
	<div style="position:relative;width: 100%;height: 80%;">
		<img class="place" src="images/prioretizations-of-http2.svg" style="transform-origin: center;transform: translate(-50%, -50%) scale(1);">
	</div>
</section>

<section class="slide">
	<h2>Один коннекшн на домен</h2>
	<p class="medium-content"></p>
	<ul>
		<li>В HTTP/2 все соединения постоянные, поэтому <mark>на домен требуется всего одно TCP соединение</mark></li>
		<li>Чаще всего HTTP-запросы маленькие и быстрые, но <mark>TCP спроектирован, чтобы лучше хорошо работать с долго-живущими соединениями</mark> и для постоянной пакетной передачи данных. Переиспользование соединений в HTTP/2 позволяет <mark>более оптимально использовать возможности TCP-соединений</mark></li>
		<li>Уменьшение количества TCP-соединений <mark>положительно сказывается на производительность HTTPS-приложений</mark> (требуется меньше вычислений для установления защищённого соединения)</li>
	</ul>
</section>

<section class="slide">
	<h2>Управление потоком данных</h2>
	<code>404 Slide Not Found</code>
	<p class="medium-content note">История, больше касающаяся серверсайда/реверс-прокси и прочих сисадминских штучек. Используется для более тщательного контроля над пересылкой данных, буферизацией и всяким таким добром</p>
</section>

<section class="slide">
	<h2>Server Push</h2>
	<div style="position:relative;width: 100%;height: 80%;">
		<img class="place" src="images/http2-server-push.svg"
			 style="transform-origin: center;transform: translate(-50%, -50%) scale(1);">
	</div>
</section>

<section class="slide">
	<h2>Сжатие заголовков</h2>
	<div style="position:relative;width: 100%;height: 80%;">
		<img class="place" src="images/http2-hpack.svg"
			 style="transform-origin: center;transform: translate(-50%, -48%) scale(0.63);">
	</div>
</section>

<section class="slide question">
	<h2>Итак... HTTP/2 очень хорош!</h2>
</section>


<section class="slide">
	<h2>Полезные ссылки</h2>
	<ul lang="en">
		<li>
			<a href="https://developers.google.com/web/fundamentals/performance/optimizing-content-efficiency/http-caching?hl=ru"
			   target="_blank">Кэширование HTTP</a> &mdash; Google Developers
		</li>
		<li><a href="https://developer.mozilla.org/ru/docs/WebSockets" target="_blank">WebSockets | MDN</a></li>
		<li><a href="https://ru.wikipedia.org/wiki/JSON-RPC" target="_blank">Описание JSON-RPC</a> и хорошая <a
				href="https://github.com/teambition/jsonrpc-lite" target="_blank">библиотечка</a> для работы с ним из
			браузера
		</li>
		<li><a href="https://habrahabr.ru/post/279291/" target="_blank">ServiceWorker и CacheStorage | Habr</a></li>
		<li>This excellent <a
				href="https://docs.google.com/presentation/d/1r7QXGYOLCh4fcUq0jDdDwKJWNqWK1o4xMtYpKZCJYjM/present?slide=id.p19"
				target="_blank">set of slides</a> has more information on some of the points covered in this
			presentation
		</li>
		<li>Vitaly Friedman: <a href="https://youtu.be/whFhyHysYYg" target="_blank">How We Moved To HTTP/2 To Improve
			Performance... And Failed</a></li>
		<li>High Performance Browser Networking (O'Reilly): <a href="https://youtu.be/whFhyHysYYg" target="_blank">HTTP/2</a>
		</li>
	</ul>
</section>

<section class="slide">
	<h2 class="shout">Всем спасибо!</h2>
</section>

<div class="progress"></div>
<script src="/lib/shower/shower.min.js"></script>
<script src="/lib/hljs/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script src="/reload/reload.js"></script>

</body>
</html>
